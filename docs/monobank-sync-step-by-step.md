# Покрокова інструкція синхронізації даних з Monobank API

Дата фіксації: 2026-02-08

## 1. Коли запускати синхронізацію

Запуск `startMonobankSync` відбувається у трьох випадках:

1. Користувач ввів токен на онбордингу.
2. Користувач оновив токен у налаштуваннях.
3. Користувач перезавантажив сторінку (resume синхронізації в браузері).

## 2. Загальний алгоритм `startMonobankSync`

1. Перевірити, чи є `clientInfo` у кеші.
2. Якщо `clientInfo` відсутній:
   - виконати `GET /personal/client-info`;
   - почекати 60 секунд перед наступним запитом до Monobank API.
3. Взяти список рахунків із `clientInfo`.
4. Відсортувати рахунки за балансом за спаданням.
5. Синхронізувати рахунки по черзі: спочатку з найбільшим балансом.
6. Для кожного рахунку виконати алгоритм з розділу 3.

## 3. Алгоритм для одного рахунку

Позначення:
- `now` = поточний час.
- `yearAgo` = `now - 1 year`.
- `firstCachedTxTime` = дата ПЕРШОЇ (найстарішої) транзакції цього рахунку в кеші.

1. Якщо транзакцій у кеші для рахунку немає:
   - синхронізувати від `now` назад до `yearAgo`;
   - інтервал між запитами: 31 доба;
   - порядок: за спаданням дат;
   - ліміт API: максимум 500 транзакцій за запит;
   - обов'язкова пауза 60 секунд між запитами.
2. Якщо транзакції в кеші є:
   - взяти `firstCachedTxTime`;
   - якщо `firstCachedTxTime <= yearAgo`, синхронізація цього рахунку завершена;
   - інакше синхронізувати від `firstCachedTxTime` назад до `yearAgo`:
     - за спаданням дат;
     - крок 31 доба;
     - не більше 500 транзакцій за запит;
     - пауза 60 секунд між запитами.

## 4. Перший запуск (кеш порожній)

1. Вибрати рахунок з найбільшою сумою грошей.
2. Синхронізувати транзакції від сьогодні до `-1 рік` за спаданням дат.
3. Інтервал між запитами: 31 доба.
4. В одному запиті максимум 500 транзакцій.
5. У найкращому випадку: 12 запитів на 372 дні (покриває 1 рік).
6. Між будь-якими запитами витримувати 60 секунд.

## 5. Якщо в одному вікні повернулося 500 транзакцій

1. Це означає, що інтервал переповнений.
2. Взяти timestamp останньої транзакції в отриманому наборі.
3. Виконати додатковий запит від цього timestamp до кінця первинного інтервалу.
4. Повторювати, доки за інтервалом не повертається `< 500`.
5. Між кожними двома запитами дотримуватись паузи 60 секунд.

## 6. Якщо рахунків декілька

1. Після завершення синхронізації поточного рахунку перейти до наступного.
2. Повторювати розділ 3 для кожного рахунку.
3. Черга рахунків завжди за балансом (від більшого до меншого).

## 7. Роль браузерної синхронізаційної прослойки

Прослойка синхронізації в браузері працює як add-only механізм:

1. Підхоплює нові транзакції в реальному часі.
2. Додає їх у кеш без втрати існуючих локальних даних.
